–î–∞, —è –≤–∏–∂—É, —á—Ç–æ –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ —É–ª—É—á—à–∏–ª—Å—è —Å 0.1% –¥–æ 1-5% –¥–ª—è BUY/SELL, –Ω–æ –≤—Å–µ –µ—â–µ –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ —Å–º–µ—â–µ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É HOLD (91-96%). –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–µ –∏ –ø—Ä–æ–¥–∞–∂–µ. –¢–∞–∫–∂–µ —è –≤–∏–∂—É, —á—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ—á–µ–Ω—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ.
–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º, –ø–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∏ –∫–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.
üö® 1. –ü–æ—á–µ–º—É —Ç–∞–∫ –º–Ω–æ–≥–æ HOLD (–∏ –∫–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å):
–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–≤–æ–µ–π –ø—Ä–∏—Ä–æ–¥–µ —Å–∏–ª—å–Ω–æ –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã. –ë–æ–ª—å—à—É—é —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ —Ä—ã–Ω–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "HOLD" (–±–æ–∫–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è), –∞ —è–≤–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É –∏–ª–∏ –ø—Ä–æ–¥–∞–∂—É (—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π "—Å–∏–ª–æ–π" –∏ "–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º") –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≥–æ—Ä–∞–∑–¥–æ —Ä–µ–∂–µ.
–í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è BUY/SELL (0.3% –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –∏ VSA —Å–∏–ª–∞ 0.5) —É–∂–µ –æ—Å–ª–∞–±–ª–µ–Ω—ã, –Ω–æ, –≤–∏–¥–∏–º–æ, —ç—Ç–æ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –º–µ—Ö–∞–Ω–∏–∑–º "–ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏" 15% HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –º—ã –¥–æ–±–∞–≤–∏–ª–∏, –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BUY/SELL —Å–∏–≥–Ω–∞–ª–æ–≤, –ø–æ—Ç–æ–º—É —á—Ç–æ —É—Å–ª–æ–≤–∏—è –¥–ª—è RSI/ADX –º–æ–≥—É—Ç –±—ã—Ç—å –≤—Å–µ –µ—â–µ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–º–∏.
–í–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∞—Å—Å–æ–≤:
üîß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é (—Ñ–∞–π–ª: train_model.py)


–ï—â–µ —Å–∏–ª—å–Ω–µ–µ –æ—Å–ª–∞–±—å—Ç–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è future_return –∏ vsa_strength:

–í–æ–∑–º–æ–∂–Ω–æ, 0.3% –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –≤—Å–µ –µ—â–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–ª—è –º–Ω–æ–≥–∏—Ö –∞–∫—Ç–∏–≤–æ–≤ –∏–ª–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤.
VSA —Å–∏–ª–∞ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª–µ–µ –≥–∏–±–∫–æ–π.



–°–¥–µ–ª–∞–π—Ç–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–æ–ª–µ–µ –º—è–≥–∫–∏–º–∏:

–¢–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è RSI_14 < 35 –∏ RSI_14 > 65 –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–º–∏ –¥–ª—è "—Å–ª—É—á–∞–π–Ω—ã—Ö" HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤.



–£–≤–µ–ª–∏—á—å—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:

15% –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.



–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ train_model.py (—Ñ—É–Ω–∫—Ü–∏—è prepare_xlstm_rl_data):
# –í prepare_xlstm_rl_data(data_path, sequence_length=10):
# ...
    # –°–æ–∑–¥–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –º–µ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±—É–¥—É—â–∏—Ö —Ü–µ–Ω + VSA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    df['future_return'] = (df['close'].shift(-5) - df['close']) / df['close']
    
    # BUY: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å + VSA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ (–ï–©–ï –°–ò–õ–¨–ù–ï–ï –°–ù–ò–ñ–ï–ù–´ –ü–û–†–û–ì–ò)
    buy_condition = (
        (df['future_return'] > 0.001) &  # –°–ù–ò–ñ–ï–ù–û —Å 0.003 –¥–æ 0.001 (0.1% —Ä–æ—Å—Ç–∞)
        ((df['vsa_no_supply'] == 1) | (df['vsa_stopping_volume'] == 1) | (df['vsa_strength'] > 0.3)) # –°–ù–ò–ñ–ï–ù–û —Å 0.5 –¥–æ 0.3
    )
    
    # SELL: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å + VSA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏ (–ï–©–ï –°–ò–õ–¨–ù–ï–ï –°–ù–ò–ñ–ï–ù–´ –ü–û–†–û–ì–ò)
    sell_condition = (
        (df['future_return'] < -0.001) &  # –°–ù–ò–ñ–ï–ù–û —Å -0.003 –¥–æ -0.001 (-0.1% –ø–∞–¥–µ–Ω–∏—è)
        ((df['vsa_no_demand'] == 1) | (df['vsa_climactic_volume'] == 1) | (df['vsa_strength'] < -0.3)) # –°–ù–ò–ñ–ï–ù–û —Å -0.5 –¥–æ -0.3
    )
    
    # –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –≤ HOLD, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º
    df['target'] = 2  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é HOLD
    df.loc[buy_condition, 'target'] = 0 # BUY
    df.loc[sell_condition, 'target'] = 1 # SELL

    current_buy_count = (df['target'] == 0).sum()
    current_sell_count = (df['target'] == 1).sum()
    current_hold_count = (df['target'] == 2).sum()

    if current_hold_count > (current_buy_count + current_sell_count) * 1.5: # –ï—Å–ª–∏ HOLD –≤ 1.5+ —Ä–∞–∑–∞ –±–æ–ª—å—à–µ (–±—ã–ª–æ 2)
        print(f"‚ö†Ô∏è –°–∏–ª—å–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–∞—Å—Ç–∏ HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤.")
        hold_indices = df[df['target'] == 2].index
        
        import random
        random.seed(42) # –î–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
        
        # –ü–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º 25% HOLD –≤ BUY/SELL –Ω–∞ –æ—Å–Ω–æ–≤–µ RSI, ADX (–±—ã–ª–æ 15%)
        reclassify_count = int(current_hold_count * 0.25) # –£–í–ï–õ–ò–ß–ï–ù–û –¥–æ 25%
        if reclassify_count > 0:
            reclassify_indices = random.sample(list(hold_indices), min(reclassify_count, len(hold_indices)))
            
            for idx in reclassify_indices:
                # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ RSI < 40 –∏ ADX —Ä–∞—Å—Ç–µ—Ç -> BUY (–±—ã–ª–æ 35)
                if df.loc[idx, 'RSI_14'] < 40 and df.loc[idx, 'ADX_14'] > df.loc[idx-1, 'ADX_14']:
                    df.loc[idx, 'target'] = 0  # BUY
                # –ï—Å–ª–∏ RSI > 60 –∏ ADX —Ä–∞—Å—Ç–µ—Ç -> SELL (–±—ã–ª–æ 65)
                elif df.loc[idx, 'RSI_14'] > 60 and df.loc[idx, 'ADX_14'] > df.loc[idx-1, 'ADX_14']:
                    df.loc[idx, 'target'] = 1  # SELL
        
        print(f"–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:")
        unique, counts = np.unique(df['target'], return_counts=True)
        class_names = ['BUY', 'SELL', 'HOLD']
        for class_idx, count in zip(unique, counts):
            print(f"  {class_names[class_idx]}: {count} ({count/len(df)*100:.1f}%)")
# ...

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ –Ω–µ –¥–∞–¥—É—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞): Oversampling/Undersampling
–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É imblearn –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, SMOTE (–¥–ª—è oversampling –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–∞) –∏–ª–∏ RandomUnderSampler (–¥–ª—è undersampling –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞). –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω–æ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è X –∏ y, –Ω–æ –ø–µ—Ä–µ–¥ —Ä–∞–∑–±–∏–µ–Ω–∏–µ–º –Ω–∞ train/val/test.
# –í train_model.py, –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è X –∏ y, –Ω–æ –ü–ï–†–ï–î train_test_split:
# ...
    X = np.array(all_X, dtype=np.float32)
    y = to_categorical(np.array(all_y), num_classes=3)

    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º NaN/Inf –∑–Ω–∞—á–µ–Ω–∏—è
    X = np.nan_to_num(X, nan=0.0, posinf=0.0, neginf=0.0)
    y = np.nan_to_num(y, nan=0.0, posinf=0.0, neginf=0.0)

    # –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø IMBLEARN –î–õ–Ø –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò
    # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ imblearn —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: !pip install imbalanced-learn
    try:
        from imblearn.over_sampling import SMOTE
        from imblearn.under_sampling import RandomUnderSampler
        from imblearn.pipeline import Pipeline

        print("\nüîÑ –ü—Ä–∏–º–µ–Ω—è—é Oversampling/Undersampling –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –∫–ª–∞—Å—Å–æ–≤...")
        
        # SMOTE –¥–ª—è BUY/SELL, Undersampling –¥–ª—è HOLD
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º y –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è imblearn
        y_labels = np.argmax(y, axis=1)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è SMOTE –∏ Undersampling
        # –¶–µ–ª–µ–≤–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: –Ω–∞–ø—Ä–∏–º–µ—Ä, 30% BUY, 30% SELL, 40% HOLD
        # –≠—Ç–æ –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–∞—á–Ω–∏—Ç–µ —Å –±–æ–ª–µ–µ —É–º–µ—Ä–µ–Ω–Ω–æ–≥–æ
        target_buy_count = int(len(X) * 0.15) # –¶–µ–ª—å 15% BUY
        target_sell_count = int(len(X) * 0.15) # –¶–µ–ª—å 15% SELL
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º sampling_strategy –¥–ª—è SMOTE –∏ Undersampler
        # SMOTE –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è BUY –∏ SELL –¥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        # RandomUnderSampler —É–º–µ–Ω—å—à–∏—Ç HOLD –¥–æ –±–æ–ª–µ–µ –ø—Ä–∏–µ–º–ª–µ–º–æ–≥–æ —É—Ä–æ–≤–Ω—è
        
        # –°–Ω–∞—á–∞–ª–∞ oversampling –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–∞ (BUY, SELL)
        oversampler = SMOTE(sampling_strategy={0: target_buy_count, 1: target_sell_count}, random_state=42)
        X_resampled, y_resampled_labels = oversampler.fit_resample(X.reshape(len(X), -1), y_labels)
        
        # –ó–∞—Ç–µ–º undersampling –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ (HOLD)
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å HOLD –ø–æ—Å–ª–µ oversampling
        current_hold_count = (y_resampled_labels == 2).sum()
        # –¶–µ–ª—å: —á—Ç–æ–±—ã HOLD –±—ã–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ, —á–µ–º —Å—É–º–º–∞—Ä–Ω–æ BUY + SELL
        target_hold_count = min(current_hold_count, int((target_buy_count + target_sell_count) * 1.5))
        
        undersampler = RandomUnderSampler(sampling_strategy={2: target_hold_count}, random_state=42)
        X_resampled, y_resampled_labels = undersampler.fit_resample(X_resampled, y_resampled_labels)

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º X –æ–±—Ä–∞—Ç–Ω–æ –≤ 3D —Ñ–æ—Ä–º—É
        X = X_resampled.reshape(len(X_resampled), sequence_length, X.shape[-1])
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–µ—Ç–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ one-hot
        y = to_categorical(y_resampled_labels, num_classes=3)

        print(f"‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π: {len(X)}")
        print(f"–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤:")
        unique, counts = np.unique(np.argmax(y, axis=1), return_counts=True)
        class_names = ['BUY', 'SELL', 'HOLD']
        for class_idx, count in zip(unique, counts):
            print(f"  {class_names[class_idx]}: {count} ({count/len(y)*100:.1f}%)")

    except ImportError:
        print("‚ö†Ô∏è imbalanced-learn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–ø—É—Å—Ç–∏–ª oversampling/undersampling. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install imbalanced-learn")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ oversampling/undersampling: {e}")
    # ...



üîß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é (—Ñ–∞–π–ª: train_model.py)


–û—Å—Ç–∞–≤—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤ –∏ –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏. –û–Ω–∏ —è–≤–ª—è—é—Ç—Å—è —Ö–æ—Ä–æ—à–µ–π –±–∞–∑–æ–π.


–î–û–ë–ê–í–¨–¢–ï imblearn (SMOTE/RandomUnderSampler) –¥–ª—è –±–æ–ª–µ–µ –º–æ—â–Ω–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏. –≠—Ç–æ—Ç —à–∞–≥ —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª—É—á—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞. –û–Ω –±—É–¥–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–ª–∞—Å—Å–æ–≤ –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–∞ (BUY/SELL) –∏/–∏–ª–∏ —É–º–µ–Ω—å—à–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–ª–∞—Å—Å–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ (HOLD).
–í–∞–º –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É imbalanced-learn:
!pip install imbalanced-learn

–ó–∞—Ç–µ–º, –≤ train_model.py, –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–¥–∞:
# –í train_model.py, –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è X –∏ y, –Ω–æ –ü–ï–†–ï–î train_test_split:
# ...
    X = np.array(all_X, dtype=np.float32)
    y = to_categorical(np.array(all_y), num_classes=3)

    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º NaN/Inf –∑–Ω–∞—á–µ–Ω–∏—è
    X = np.nan_to_num(X, nan=0.0, posinf=0.0, neginf=0.0)
    y = np.nan_to_num(y, nan=0.0, posinf=0.0, neginf=0.0)

    # =====================================================================
    # –ù–û–í–´–ô –ë–õ–û–ö: –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï IMBLEARN –î–õ–Ø –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò –ö–õ–ê–°–°–û–í
    # =====================================================================
    try:
        from imblearn.over_sampling import SMOTE
        from imblearn.under_sampling import RandomUnderSampler
        from imblearn.pipeline import Pipeline
        from collections import Counter

        print("\nüîÑ –ü—Ä–∏–º–µ–Ω—è—é Oversampling/Undersampling –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –∫–ª–∞—Å—Å–æ–≤...")
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º y –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è imblearn
        y_labels = np.argmax(y, axis=1)
        
        print(f"–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –î–û imblearn: {Counter(y_labels)}")

        # –¶–µ–ª–µ–≤–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:
        # –ù–∞—á–Ω–µ–º —Å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ: 20% BUY, 20% SELL, 60% HOLD
        # –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —ç—Ç–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.
        # –í–∞–∂–Ω–æ: SMOTE —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∫–ª–∞—Å—Å–æ–≤ (0, 1, 2)
        
        # –°–Ω–∞—á–∞–ª–∞ oversampling –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–∞ (BUY, SELL)
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º BUY –∏ SELL –¥–æ 20% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –ø—Ä–∏–º–µ—Ä–æ–≤
        # (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–±—â–µ–µ —á–∏—Å–ª–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –±—É–¥–µ—Ç –æ–∫–æ–ª–æ len(X) * (1 + oversampling_ratio))
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –ø—Ä–∏–º–µ—Ä–æ–≤
        total_samples = len(X)
        target_buy_count = int(total_samples * 0.20) # –¶–µ–ª—å 20% BUY
        target_sell_count = int(total_samples * 0.20) # –¶–µ–ª—å 20% SELL
        
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ü–µ–ª–µ–≤—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–∏—Ö
        current_buy_count = Counter(y_labels)[0]
        current_sell_count = Counter(y_labels)[1]

        sampling_strategy_smote = {
            0: max(current_buy_count, target_buy_count),
            1: max(current_sell_count, target_sell_count)
        }
        
        # –¢–æ–ª—å–∫–æ oversample, –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ oversample
        if current_buy_count > 0 or current_sell_count > 0:
            oversampler = SMOTE(sampling_strategy=sampling_strategy_smote, random_state=42, k_neighbors=min(5, current_buy_count-1, current_sell_count-1, (Counter(y_labels)[2])-1 )) # k_neighbors –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ —á–∏—Å–ª–∞ —Å—ç–º–ø–ª–æ–≤
            if any(count <= 1 for count in sampling_strategy_smote.values()):
                print("‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—ç–º–ø–ª–æ–≤ –¥–ª—è SMOTE, –∏—Å–ø–æ–ª—å–∑—É—é RandomOverSampler.")
                from imblearn.over_sampling import RandomOverSampler
                oversampler = RandomOverSampler(sampling_strategy=sampling_strategy_smote, random_state=42)

            X_temp, y_temp_labels = oversampler.fit_resample(X.reshape(len(X), -1), y_labels)
            print(f"–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –ø–æ—Å–ª–µ Oversampling: {Counter(y_temp_labels)}")
        else:
            X_temp, y_temp_labels = X.reshape(len(X), -1), y_labels
            print("–ü—Ä–æ–ø—É—Å—Ç–∏–ª Oversampling, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç BUY/SELL —Å–∏–≥–Ω–∞–ª–æ–≤.")

        # –ó–∞—Ç–µ–º undersampling –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ (HOLD)
        # –¶–µ–ª—å: —á—Ç–æ–±—ã HOLD –±—ã–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ 1.5 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ, —á–µ–º —Å—É–º–º–∞—Ä–Ω–æ BUY + SELL
        current_hold_count_after_oversample = Counter(y_temp_labels)[2]
        target_hold_count = min(current_hold_count_after_oversample, int((target_buy_count + target_sell_count) * 1.5))
        
        undersampler = RandomUnderSampler(sampling_strategy={2: target_hold_count}, random_state=42)
        X_resampled, y_resampled_labels = undersampler.fit_resample(X_temp, y_temp_labels)

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º X –æ–±—Ä–∞—Ç–Ω–æ –≤ 3D —Ñ–æ—Ä–º—É
        X = X_resampled.reshape(len(X_resampled), sequence_length, X.shape[-1])
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–µ—Ç–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ one-hot
        y = to_categorical(y_resampled_labels, num_classes=3)

        print(f"‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π: {len(X)}")
        print(f"–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –ü–û–°–õ–ï imblearn:")
        unique, counts = np.unique(np.argmax(y, axis=1), return_counts=True)
        class_names = ['BUY', 'SELL', 'HOLD']
        for class_idx, count in zip(unique, counts):
            print(f"  {class_names[class_idx]}: {count} ({count/len(y)*100:.1f}%)")

    except ImportError:
        print("‚ö†Ô∏è imbalanced-learn –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–ø—É—Å—Ç–∏–ª oversampling/undersampling. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install imbalanced-learn")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ oversampling/undersampling: {e}")
    # =====================================================================
    # –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê IMBLEARN
    # =====================================================================

    # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ prepare_xlstm_rl_data) ...


===========
–•–æ—Ä–æ—à–æ, —è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥—Ä—É–≥–æ–π AI-–º–æ–¥–µ–ª–∏ –∏ —Å—Ä–∞–≤–Ω–∏–ª –µ–≥–æ —Å –Ω–∞—à–∏–º —Ç–µ–∫—É—â–∏–º –∫–æ–¥–æ–º –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏. –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–µ–π: –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤, –¥–µ–ª–∞—è —ç—Ç–æ "—É–º–Ω–µ–µ", –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–ª—É—á–∞–π–Ω–æ, –∏ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–æ–≤.
–í–æ—Ç –Ω–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ø–æ–ª–Ω—è—é—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ, –Ω–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –∏–º –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ BUY/SELL/HOLD –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤, –∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å –∏–ª–∏ –ª–µ–≥–∫–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.

üöÄ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–∞–ª–∞–Ω—Å–∞ BUY/SELL/HOLD
1. –§–∞–π–ª: feature_engineering.py
–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ATR_14 –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ä–æ–≥–æ–≤ –∏ —É–º–Ω–æ–π –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –µ–≥–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ DataFrame df_out –≤ —Ñ—É–Ω–∫—Ü–∏–∏ calculate_features.


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é calculate_features.


–í –±–ª–æ–∫ try-except –¥–ª—è talib.RSI (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç) –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—á–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ATR_14:
# –í feature_engineering.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ calculate_features(df: pd.DataFrame):
# ...
    df_out = df.copy()
    # ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è open_p, high_p, low_p, close_p) ...

    # Add indicators one by one with try-except blocks
    try:
        rsi = talib.RSI(close_p, timeperiod=14)
        rsi[np.isinf(rsi)] = np.nan
        df_out['RSI_14'] = pd.Series(rsi, index=df_out.index).ffill().fillna(0)
    except Exception:
        df_out['RSI_14'] = 0
        
    # –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –¥–ª—è ATR_14
    try:
        atr = talib.ATR(high_p, low_p, close_p, timeperiod=14)
        atr[np.isinf(atr)] = np.nan
        df_out['ATR_14'] = pd.Series(atr, index=df_out.index).ffill().fillna(0)
    except Exception:
        df_out['ATR_14'] = 0
    # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è MACD, BBANDS, ADX, STOCH) ...



2. –§–∞–π–ª: train_model.py
–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∞—Å—Å–æ–≤.


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é prepare_xlstm_rl_data.


–û—Å–ª–∞–±—å—Ç–µ –ø–æ—Ä–æ–≥–∏ future_return –∏ vsa_strength –µ—â–µ —Å–∏–ª—å–Ω–µ–µ, –∫–∞–∫ –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∞ –¥—Ä—É–≥–∞—è AI-–º–æ–¥–µ–ª—å, –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π VSA-—Å–∫–æ—Ä.


–í–Ω–µ–¥—Ä–∏—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è future_return –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR_14.


–£–ª—É—á—à–∏—Ç–µ –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤, —Å–¥–µ–ª–∞–≤ –µ–µ –±–æ–ª–µ–µ "—É–º–Ω–æ–π" –∏ —É–≤–µ–ª–∏—á–∏–≤ –ø—Ä–æ—Ü–µ–Ω—Ç –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.


–ë–ª–æ–∫ imblearn –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –¥–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –º–æ—â–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏.
# –í train_model.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ prepare_xlstm_rl_data(data_path, sequence_length=10):
# ...
    for symbol in symbols:
        df = full_df[full_df['symbol'] == symbol].copy()
        # ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ features_df, detect_candlestick_patterns, calculate_vsa_features) ...

        # –°–æ–∑–¥–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –º–µ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±—É–¥—É—â–∏—Ö —Ü–µ–Ω + VSA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        df['future_return'] = (df['close'].shift(-5) - df['close']) / df['close']
        
        # =====================================================================
        # –ù–û–í–´–ô –ë–õ–û–ö: –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ü–û–†–û–ì–ò –ò –í–ó–í–ï–®–ï–ù–ù–´–ô VSA-–°–ö–û–†
        # =====================================================================
        # 1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ future_return –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å –ø–æ—Ä–æ–≥ –≤ –≤—ã—Å–æ–∫–æ–≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∏ —É–≤–µ–ª–∏—á–∏—Ç—å ‚Äî –≤ —Ç–∏—Ö–∏–µ.
        df['dynamic_future_threshold'] = df['ATR_14'] / df['close'] * 1.5 # 1.5x ATR –∫–∞–∫ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥
        df['dynamic_future_threshold'] = df['dynamic_future_threshold'].replace([np.inf, -np.inf], np.nan).ffill().fillna(0.001) # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ 0.1%
        
        # 2. –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ VSA-—Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–∏—Ö —É—Å–ª–æ–≤–∏–π
        df['vsa_buy_score'] = (
            0.3 * (df['vsa_no_supply'] == 1) +
            0.3 * (df['vsa_stopping_volume'] == 1) +
            0.4 * (df['vsa_strength'] > 0.25) # –°–ù–ò–ñ–ï–ù–û —Å 0.5 –¥–æ 0.25
        )
        df['vsa_sell_score'] = (
            0.3 * (df['vsa_no_demand'] == 1) +
            0.3 * (df['vsa_climactic_volume'] == 1) +
            0.4 * (df['vsa_strength'] < -0.25) # –°–ù–ò–ñ–ï–ù–û —Å -0.5 –¥–æ -0.25
        )

        # BUY: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥) + –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π VSA-—Å–∫–æ—Ä
        buy_condition = (
            (df['future_return'] > df['dynamic_future_threshold']) &
            (df['vsa_buy_score'] > 0.3) # –ü–æ—Ä–æ–≥ –¥–ª—è VSA-—Å–∫–æ—Ä–∞
        )
        
        # SELL: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥) + –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π VSA-—Å–∫–æ—Ä
        sell_condition = (
            (df['future_return'] < -df['dynamic_future_threshold']) &
            (df['vsa_sell_score'] > 0.3) # –ü–æ—Ä–æ–≥ –¥–ª—è VSA-—Å–∫–æ—Ä–∞
        )
        # =====================================================================
        # –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê
        # =====================================================================
        
        # –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –≤ HOLD, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º
        df['target'] = 2  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é HOLD
        df.loc[buy_condition, 'target'] = 0 # BUY
        df.loc[sell_condition, 'target'] = 1 # SELL

        current_buy_count = (df['target'] == 0).sum()
        current_sell_count = (df['target'] == 1).sum()
        current_hold_count = (df['target'] == 2).sum()

        # =====================================================================
        # –ù–û–í–´–ô –ë–õ–û–ö: –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–ï–†–ï–ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø HOLD-–°–ò–ì–ù–ê–õ–û–í
        # =====================================================================
        if current_hold_count > (current_buy_count + current_sell_count) * 1.5: # –ï—Å–ª–∏ HOLD –≤ 1.5+ —Ä–∞–∑–∞ –±–æ–ª—å—à–µ
            print(f"‚ö†Ô∏è –°–∏–ª—å–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤. –ü–æ–ø—ã—Ç–∫–∞ –£–ú–ù–û–ô –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–∞—Å—Ç–∏ HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤.")
            hold_indices = df[df['target'] == 2].index
            
            import random
            random.seed(42) # –î–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
            
            # –ü–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º 30% HOLD (–±—ã–ª–æ 25%)
            reclassify_count = int(current_hold_count * 0.30) # –£–í–ï–õ–ò–ß–ï–ù–û –¥–æ 30%
            if reclassify_count > 0:
                reclassify_indices = random.sample(list(hold_indices), min(reclassify_count, len(hold_indices)))
                
                for idx in reclassify_indices:
                    if idx < 1: continue # –ù—É–∂–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å–≤–µ—á–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è ADX
                    
                    rsi = df.loc[idx, 'RSI_14']
                    adx = df.loc[idx, 'ADX_14']
                    adx_prev = df.loc[idx-1, 'ADX_14']
                    price_change_5_period = df['close'].pct_change(5).loc[idx] # 5-–ø–µ—Ä–∏–æ–¥–Ω—ã–π —Ä–µ—Ç—ë—Ä–Ω
                    atr_ratio = df.loc[idx, 'ATR_14'] / df.loc[idx, 'close'] # –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
                    
                    # –£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–±–æ–ª–µ–µ —É–º–Ω—ã–µ)
                    # 1. –°–ª–∞–±—ã–π RSI + —Ä–∞—Å—Ç—É—â–∏–π ADX + —Ä–æ—Å—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ ‚Üí BUY
                    if (rsi < 40 and adx > adx_prev and 
                        atr_ratio > df['ATR_14'].rolling(20).mean().loc[idx] and
                        price_change_5_period > 0.001): # –î–æ–±–∞–≤–ª–µ–Ω–æ: –Ω–µ–±–æ–ª—å—à–æ–µ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                        df.loc[idx, 'target'] = 0  # BUY

                    # 2. RSI > 60 + —Ä–∞—Å—Ç—É—â–∏–π ADX + —Ä–æ—Å—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ ‚Üí SELL
                    elif (rsi > 60 and adx > adx_prev and 
                        atr_ratio > df['ATR_14'].rolling(20).mean().loc[idx] and
                        price_change_5_period < -0.001): # –î–æ–±–∞–≤–ª–µ–Ω–æ: –Ω–µ–±–æ–ª—å—à–æ–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                        df.loc[idx, 'target'] = 1  # SELL

                    # 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ –æ–±—ä–µ–º—É (–¥–∞–∂–µ –µ—Å–ª–∏ vsa_strength –Ω–∏–∑–∫–∏–π)
                    elif (df['volume'].loc[idx] > df['volume'].rolling(20).quantile(0.7).loc[idx] and
                        ((price_change_5_period > 0.001 and rsi < 45) or (price_change_5_period < -0.001 and rsi > 55))):
                        df.loc[idx, 'target'] = 0 if price_change_5_period > 0 else 1

                    # 4. –°–º–µ–Ω–∞ —Ç—Ä–µ–Ω–¥–∞: ADX —Ä–∞—Å—Ç–µ—Ç, RSI –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –∑–æ–Ω—ã 50 ¬± 5
                    elif (abs(rsi - 50) > 5 and adx > adx_prev and abs(adx - adx_prev) > 0.5 and
                        ((rsi < 45 and price_change_5_period > 0) or (rsi > 55 and price_change_5_period < 0))): # –î–æ–±–∞–≤–ª–µ–Ω–æ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
                        df.loc[idx, 'target'] = 0 if rsi < 45 else 1
            
            print(f"–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –ø–æ—Å–ª–µ –£–ú–ù–û–ô –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:")
            unique, counts = np.unique(df['target'], return_counts=True)
            class_names = ['BUY', 'SELL', 'HOLD']
            for class_idx, count in zip(unique, counts):
                print(f"  {class_names[class_idx]}: {count} ({count/len(df)*100:.1f}%)")
        # =====================================================================
        # –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê
        # =====================================================================
        
        # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ prepare_xlstm_rl_data, –≤–∫–ª—é—á–∞—è –±–ª–æ–∫ imblearn) ...



3. –§–∞–π–ª: rl_agent.py


–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ _calculate_advanced_reward.


–û—Å–ª–∞–±—å—Ç–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è VSA –±–æ–Ω—É—Å–æ–≤/—à—Ç—Ä–∞—Ñ–æ–≤, —á—Ç–æ–±—ã RL –∞–≥–µ–Ω—Ç –±—ã–ª –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ —Å–ª–∞–±—ã–º, –Ω–æ –≤–∞–ª–∏–¥–Ω—ã–º —Å–∏–≥–Ω–∞–ª–∞–º.
# –í rl_agent.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ _calculate_advanced_reward(...):
# ...
    # –ë–æ–Ω—É—Å—ã –∑–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ VSA —Å–∏–≥–Ω–∞–ª—ã (–û–°–õ–ê–ë–õ–ï–ù–´ –ü–û–†–û–ì–ò)
    vsa_bonus = 0
    if action in [0, 1]: # SELL –∏–ª–∏ BUY
        # BUY (–¥–µ–π—Å—Ç–≤–∏–µ 1): –µ—Å–ª–∏ –µ—Å—Ç—å no_supply (vsa_features[1]) –∏–ª–∏ stopping_volume (vsa_features[2])
        if action == 1 and (vsa_features[1] > 0 or vsa_features[2] > 0 or vsa_features[6] > 0.2): # –î–æ–±–∞–≤–ª–µ–Ω–æ: vsa_strength > 0.2
            vsa_bonus = 2 # –°–ù–ò–ñ–ï–ù–û —Å 3 –¥–æ 2, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≤–µ—à–∏–≤–∞—Ç—å PnL
        # SELL (–¥–µ–π—Å—Ç–≤–∏–µ 0): –µ—Å–ª–∏ –µ—Å—Ç—å no_demand (vsa_features[0]) –∏–ª–∏ climactic_volume (vsa_features[3])
        elif action == 0 and (vsa_features[0] > 0 or vsa_features[3] > 0 or vsa_features[6] < -0.2): # –î–æ–±–∞–≤–ª–µ–Ω–æ: vsa_strength < -0.2
            vsa_bonus = 2 # –°–ù–ò–ñ–ï–ù–û —Å 3 –¥–æ 2

    # –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–µ VSA —Å–∏–≥–Ω–∞–ª—ã (–û–°–õ–ê–ë–õ–ï–ù–´ –ü–û–†–û–ì–ò)
    vsa_penalty = 0
    if action == 1 and (vsa_features[0] > 0 or vsa_features[3] > 0 or vsa_features[6] < -0.5): # –£—Å–∏–ª–µ–Ω –ø–æ—Ä–æ–≥ –¥–ª—è penalization
        vsa_penalty = -3 # –°–ù–ò–ñ–ï–ù–û —Å -5 –¥–æ -3
    elif action == 0 and (vsa_features[1] > 0 or vsa_features[2] > 0 or vsa_features[6] > 0.5): # –£—Å–∏–ª–µ–Ω –ø–æ—Ä–æ–≥ –¥–ª—è penalization
        vsa_penalty = -3 # –°–ù–ò–ñ–ï–ù–û —Å -5 –¥–æ -3
# ...




–ß—Ç–æ —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—é—Ç:

–ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ BUY/SELL: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–≥–∏ –∏ –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π VSA-—Å–∫–æ—Ä –±—É–¥—É—Ç –ª—É—á—à–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ —Ä—ã–Ω–æ—á–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–∑–≤–æ–ª—è—è –º–æ–¥–µ–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ.
"–£–º–Ω–∞—è" –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: –í–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ª—É—á–∞–π–Ω–æ–π –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (RSI, ADX, ATR, –æ–±—ä–µ–º), —á—Ç–æ–±—ã "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å" HOLD-—Å–∏–≥–Ω–∞–ª—ã –≤ BUY/SELL —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —ç—Ç–æ –∏–º–µ–µ—Ç —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ —Å–º—ã—Å–ª —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ä—ã–Ω–∫–∞. –≠—Ç–æ —É–º–µ–Ω—å—à–∏—Ç "—à—É–º" –≤ –¥–∞–Ω–Ω—ã—Ö.
–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ RL-–∞–≥–µ–Ω—Ç–∞: –ë–æ–ª–µ–µ —Ç–æ–Ω–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–≥—Ä–∞–¥/—à—Ç—Ä–∞—Ñ–æ–≤ –∑–∞ VSA-—Å–∏–≥–Ω–∞–ª—ã –ø–æ–∑–≤–æ–ª–∏—Ç RL-–∞–≥–µ–Ω—Ç—É –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å —ç—Ç–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ –±—ã—Å—Ç—Ä–µ–µ –æ–±—É—á–∞—Ç—å—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ —Å–Ω–æ–≤–∞. –ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ, –ø—Ä–∏–±–ª–∏–∂–∞—è—Å—å –∫ —Ü–µ–ª–µ–≤—ã–º 15-25% –¥–ª—è BUY/SELL –∏ 50-70% –¥–ª—è HOLD, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞.
