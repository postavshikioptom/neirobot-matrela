–•–æ—Ä–æ—à–æ, —è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏–ª –ª–æ–≥–∏ –æ–±—É—á–µ–Ω–∏—è –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –º–æ–∑–≥–æ–≤–æ–π —à—Ç—É—Ä–º –æ—Ç –¥—Ä—É–≥–æ–π AI-–º–æ–¥–µ–ª–∏. –í—ã–≤–æ–¥—ã –ø–æ –ª–æ–≥–∞–º –∏ –∏–¥–µ–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—á–µ–Ω—å —Ü–µ–Ω–Ω—ã.
üö® –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö –ª–æ–≥–æ–≤ –∏ –∫–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
–í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã –≤ —Å–≤–æ–∏—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏—è—Ö:


val_loss —Ç–µ–ø–µ—Ä—å –¥–æ–≤–æ–ª—å–Ω–æ –±–æ–ª—å—à–æ–π (–æ–∫–æ–ª–æ 1.15-1.22) –∏ –Ω–µ —Å–Ω–∏–∂–∞–µ—Ç—Å—è. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –≤—Å–µ –µ—â–µ –ø–µ—Ä–µ–æ–±—É—á–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –æ–±–æ–±—â–∞—Ç—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.


–ú–µ—Ç—Ä–∏–∫–∏ accuracy: 0.55-0.60, val_accuracy: 0.14-0.27: –†–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é –æ–≥—Ä–æ–º–µ–Ω, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–∑–Ω–∞–∫–æ–º –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.


–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º:

Class 0 (BUY): Prec=0.59-0.62, Rec=0.63-0.71
Class 1 (SELL): Prec=0.58-0.61, Rec=0.63-0.73
Class 2 (HOLD): Prec=0.75-0.81, Rec=0.04-0.12

–≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤–∞—à –≤—ã–≤–æ–¥: –º–æ–¥–µ–ª—å –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç HOLD (Recall –¥–ª—è HOLD –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π), –Ω–æ –∫–æ–≥–¥–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, —Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é (Precision –¥–ª—è HOLD –≤—ã—Å–æ–∫–∏–π). –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å BUY –∏–ª–∏ SELL, –¥–∞–∂–µ –∫–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ–≤–µ—Ä–Ω–æ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
–í–∞—à –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥ –≤–µ—Ä–µ–Ω: "—Å–∏–ª—å–Ω–æ –ø–µ—Ä–µ–∫—Ä—É—Ç–∏–ª–∏ HOLD". –ú—ã —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ –Ω–∞–∫–∞–∑–∞–ª–∏ –º–æ–¥–µ–ª—å –∑–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ HOLD, –∏ –æ–Ω–∞ —Ç–µ–ø–µ—Ä—å –µ–≥–æ –∏–∑–±–µ–≥–∞–µ—Ç.


‚ö†Ô∏è –í–∞–∂–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞ –æ "–∑–∞–º–∞–∑—ã–≤–∞–Ω–∏–∏ –¥—ã—Ä" (–∏ –ø–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ):
–í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã: "–≤—Å–µ, —á—Ç–æ –º—ã —Å–µ–π—á–∞—Å –∫—Ä—É—Ç–∏–º –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—É—á–µ–Ω–∏—è, —á—Ç–æ–± –ø–æ—Ç–æ–º –º–æ–¥–µ–ª—å —Ç–∞–∫ –∂–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞ –ø–æ—Ç–æ–º –∏ –Ω–∞ —ç—Ç–∞–ø–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –∏ –Ω–∞ —ç—Ç–∞–ø–µ —Ç–æ—Ä–≥–æ–≤. –ß—Ç–æ–± –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, —á—Ç–æ –º—ã –∑–∞–º–∞–∑—ã–≤–∞–µ–º –≥–¥–µ—Ç–æ –¥—ã—Ä—ã, —á—Ç–æ–±—ã –∏—Ö –Ω–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ, –ø–æ–¥–≥–æ–Ω—è—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ –Ω—É–∂–Ω—ã–º –Ω–∞–º. –ê –ø–æ—Ç–æ–º —ç—Ç–æ –≤—Å–µ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–æ—è–≤–∏—Ç—Å—è".
–ò–º–µ–Ω–Ω–æ —ç—Ç–æ —Å–µ–π—á–∞—Å –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. –ú—ã –ø—ã—Ç–∞–ª–∏—Å—å –∑–∞—Å—Ç–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å BUY/SELL, –Ω–æ –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–∞—É—á–∏—Ç—å –µ–µ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å —ç—Ç–∏ –∫–ª–∞—Å—Å—ã, –º—ã –ø—Ä–æ—Å—Ç–æ "–≤—ã–¥–∞–≤–∏–ª–∏" –µ–µ –∏–∑ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è HOLD. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –º–æ–¥–µ–ª—å —Å—Ç–∞–ª–∞ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π, –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—è BUY/SELL –¥–∞–∂–µ –∫–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–æ, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–ª–æ—Ö–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
–ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –±–∞–ª–∞–Ω—Å: –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ —É–º–µ—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ —Ç—Ä–∏ –∫–ª–∞—Å—Å–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∏–ª—å–Ω—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–∏–≥–Ω–∞–ª.
üöÄ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∫–æ–¥–∞ (—Ñ–æ–∫—É—Å –Ω–∞ "—Å–º—ã—Å–ª–µ, –∞ –Ω–µ —á–∞—Å—Ç–æ—Ç–µ")
–Ø –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É—é –∏–¥–µ–∏ –∏–∑ –º–æ–∑–≥–æ–≤–æ–≥–æ —à—Ç—É—Ä–º–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –∏ –Ω–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –Ω–∞—à–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º. –ú—ã —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ —Ç–æ–º, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞–ª–∞, –∫–æ–≥–¥–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å HOLD, –∏ –∫–æ–≥–¥–∞ BUY/SELL, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ HOLD.

1. –§–∞–π–ª: train_model.py
–ú—ã –µ—â–µ —Ä–∞–∑ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã –¥–∞—Ç—å HOLD –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤, –∏ –≤–Ω–µ–¥—Ä–∏–º –±–æ–ª–µ–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ç–æ–º—É, –∫–æ–≥–¥–∞ —Å—á–∏—Ç–∞—Ç—å —Å–∏–≥–Ω–∞–ª BUY/SELL.
1.1. –û—Å–ª–∞–±—å—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å imblearn –µ—â–µ —Å–∏–ª—å–Ω–µ–µ (—Ü–µ–ª–µ–≤—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã):
–ú—ã —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–∏ HOLD. –î–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω–µ–º –µ–≥–æ –∫ –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–º—É —É—Ä–æ–≤–Ω—é, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –≤–∏–¥–µ–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤.


–ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï IMBLEARN –î–õ–Ø –ë–ê–õ–ê–ù–°–ò–†–û–í–ö–ò –ö–õ–ê–°–°–û–í.


–ò–∑–º–µ–Ω–∏—Ç–µ target_buy_count, target_sell_count, –∞ —Ç–∞–∫–∂–µ target_hold_count:
# –í train_model.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ prepare_xlstm_rl_data(...):
# ...
    # –¶–µ–ª–µ–≤–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: 10% BUY, 10% SELL, 80% HOLD (–±—ã–ª–æ 15/15/70)
    # –≠—Ç–æ –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö,
    # –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –Ω–∞—É—á–∏—Ç—å—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å HOLD —á–∞—â–µ.
    total_samples = len(X)
    target_buy_count = int(total_samples * 0.10) # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 0.15 –Ω–∞ 0.10
    target_sell_count = int(total_samples * 0.10) # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 0.15 –Ω–∞ 0.10
    
    current_buy_count = Counter(y_labels)[0]
    current_sell_count = Counter(y_labels)[1]

    sampling_strategy_smote = {
        0: max(current_buy_count, target_buy_count),
        1: max(current_sell_count, target_sell_count)
    }
    
    # ... (–∫–æ–¥ SMOTE) ...

    # Undersampling HOLD: –¶–µ–ª—å - —á—Ç–æ–±—ã HOLD –±—ã–ª –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ, —á–µ–º —Å—É–º–º–∞ BUY + SELL
    current_hold_count_after_oversample = Counter(y_temp_labels)[2]
    target_hold_count = min(current_hold_count_after_oversample, int((Counter(y_temp_labels)[0] + Counter(y_temp_labels)[1]) * 3.0)) # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 2.0 –Ω–∞ 3.0
    
    undersampler = RandomUnderSampler(sampling_strategy={2: target_hold_count}, random_state=42)
    X_resampled, y_resampled_labels = undersampler.fit_resample(X_temp, y_temp_labels)
# ...



1.2. –û—Å–ª–∞–±—å—Ç–µ additional_weight_multiplier –¥–ª—è BUY/SELL –∫–ª–∞—Å—Å–æ–≤ –µ—â–µ –±–æ–ª—å—à–µ:
–ú–æ–¥–µ–ª—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ "–±–æ–∏—Ç—Å—è" –æ—à–∏–±–∏—Ç—å—Å—è –Ω–∞ BUY/SELL. –î–∞–¥–∏–º –µ–π –±–æ–ª—å—à–µ "—Å–≤–æ–±–æ–¥—ã" –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è HOLD.


–ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ –í–´–ß–ò–°–õ–ï–ù–ò–ï –ò –ü–ï–†–ï–î–ê–ß–ê –í–ï–°–û–í –ö–õ–ê–°–°–û–í.


–ò–∑–º–µ–Ω–∏—Ç–µ additional_weight_multiplier:
# –í train_model.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ train_xlstm_rl_system(...):
# ...
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ –≤–µ—Å–æ–≤ BUY/SELL
additional_weight_multiplier = 1.0 # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 1.2 –Ω–∞ 1.0 (—Ç.–µ. –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ "balanced")
if 0 in class_weight_dict:
    class_weight_dict[0] *= additional_weight_multiplier
if 1 in class_weight_dict:
    class_weight_dict[1] *= additional_weight_multiplier
# ...



1.3. –û—Å–ª–∞–±—å—Ç–µ "–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å" –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ HOLD-—Å–∏–≥–Ω–∞–ª–æ–≤:
–ú—ã —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ –ø—ã—Ç–∞–ª–∏—Å—å "–≤—ã–¥–∞–≤–∏—Ç—å" BUY/SELL –∏–∑ HOLD. –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –±—ã–ª–∞ –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–π.


–ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–ï–†–ï–ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø HOLD-–°–ò–ì–ù–ê–õ–û–í.


–£–º–µ–Ω—å—à–∏—Ç–µ reclassify_count –∏ —Å–¥–µ–ª–∞–π—Ç–µ —É—Å–ª–æ–≤–∏—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–º–∏:
# –í train_model.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ prepare_xlstm_rl_data(...):
# ...
        # –ü–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º 20% HOLD (–±—ã–ª–æ 40%)
        reclassify_count = int(current_hold_count * 0.20) # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 0.40 –Ω–∞ 0.20
        if reclassify_count > 0:
            reclassify_indices = random.sample(list(hold_indices), min(reclassify_count, len(hold_indices)))
            
            for idx in reclassify_indices:
                if idx < 1: continue
                
                rsi = df.loc[idx, 'RSI_14']
                adx = df.loc[idx, 'ADX_14']
                adx_prev = df.loc[idx-1, 'ADX_14']
                price_change_5_period = df['close'].pct_change(5).loc[idx]
                atr_ratio = df.loc[idx, 'ATR_14'] / df.loc[idx, 'close']
                
                # –£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ë–û–õ–ï–ï –°–¢–†–û–ì–ò–ï)
                # 1. –°–ª–∞–±—ã–π RSI + —Å–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç ADX + –±–æ–ª–µ–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ ‚Üí BUY
                if (rsi < 40 and adx > adx_prev + 0.5 and abs(price_change_5_period) > 0.001): # ADX —Ä–∞—Å—Ç–µ—Ç —Å–∏–ª—å–Ω–µ–µ, price_change > 0.1%
                    df.loc[idx, 'target'] = 0  # BUY

                # 2. RSI > 60 + —Å–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç ADX + –±–æ–ª–µ–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ ‚Üí SELL
                elif (rsi > 60 and adx > adx_prev + 0.5 and abs(price_change_5_period) > 0.001): # ADX —Ä–∞—Å—Ç–µ—Ç —Å–∏–ª—å–Ω–µ–µ, price_change > 0.1%
                    df.loc[idx, 'target'] = 1  # SELL

                # 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ –æ–±—ä–µ–º—É (–±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–π –æ–±—ä–µ–º)
                elif (df['volume'].loc[idx] > df['volume'].rolling(20).quantile(0.8).loc[idx] and # –ö–≤–∞–Ω—Ç–∏–ª—å 0.8 (–±—ã–ª–æ 0.6)
                    ((price_change_5_period > 0.001 and rsi < 50) or (price_change_5_period < -0.001 and rsi > 50))): # price_change > 0.1%
                    df.loc[idx, 'target'] = 0 if price_change_5_period > 0 else 1

                # 4. –°–º–µ–Ω–∞ —Ç—Ä–µ–Ω–¥–∞: ADX —Ä–∞—Å—Ç–µ—Ç —Å–∏–ª—å–Ω–µ–µ, RSI –æ—Ç—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ –æ—Ç 50
                elif (abs(rsi - 50) > 7 and adx > adx_prev + 1.0): # abs(rsi-50) > 7 (–±—ã–ª–æ 3), ADX —Ä–∞—Å—Ç–µ—Ç —Å–∏–ª—å–Ω–µ–µ
                    df.loc[idx, 'target'] = 0 if rsi < 50 else 1 
# ...



2. –§–∞–π–ª: xlstm_rl_model.py
–ú—ã –¥–æ–±–∞–≤–∏–º L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—é –≤ XLSTMLayer –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏ –≤–µ—Å–æ–≤, –∞ —Ç–∞–∫–∂–µ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ recurrent_dropout —É–¥–∞–ª–µ–Ω.
2.1. –î–æ–±–∞–≤—å—Ç–µ kernel_regularizer=l1(0.0001) –≤ XLSTMLayer:
L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è (Lasso) –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –≤–µ—Å–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω—É–ª–µ–≤—ã–º–∏, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤ –æ—Ç–±–æ—Ä–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏ —É–ø—Ä–æ—â–∞–µ—Ç –º–æ–¥–µ–ª—å, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ.


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é build_model.


–î–æ–±–∞–≤—å—Ç–µ kernel_regularizer=l1(0.0001) –∫ –∫–∞–∂–¥–æ–º—É XLSTMLayer:
# –í models/xlstm_rl_model.py, –≤ –∫–ª–∞—Å—Å–µ XLSTMRLModel, –≤ –º–µ—Ç–æ–¥–µ build_model():
# ...
from tensorflow.keras.regularizers import l1, l2 # <--- –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç l1

class XLSTMRLModel:
    # ...
    def build_model(self):
        # ...
        # –ü–µ—Ä–≤—ã–π xLSTM —Å–ª–æ–π —Å –≤–Ω–µ—à–Ω–µ–π –ø–∞–º—è—Ç—å—é
        xlstm1 = XLSTMLayer(
            units=self.memory_units,
            memory_size=self.memory_size,
            return_sequences=True,
            kernel_regularizer=l1(0.0001), # <--- –î–û–ë–ê–í–õ–ï–ù–û: L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
            name='xlstm_memory_layer_1'
        )(inputs)
        xlstm1 = LayerNormalization()(xlstm1)
        
        # –í—Ç–æ—Ä–æ–π xLSTM —Å–ª–æ–π
        xlstm2 = XLSTMLayer(
            units=self.memory_units // 2,
            memory_size=self.memory_size // 2,
            return_sequences=True,
            kernel_regularizer=l1(0.0001), # <--- –î–û–ë–ê–í–õ–ï–ù–û: L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
            name='xlstm_memory_layer_2'
        )(xlstm1)
        xlstm2 = LayerNormalization()(xlstm2)
        
        # –ú–µ—Ö–∞–Ω–∏–∑–º –≤–Ω–∏–º–∞–Ω–∏—è
        attention = Attention(name='attention_mechanism')([xlstm2, xlstm2])
        
        # –§–∏–Ω–∞–ª—å–Ω—ã–π xLSTM —Å–ª–æ–π
        xlstm_final = XLSTMLayer(
            units=self.attention_units,
            memory_size=self.attention_units,
            return_sequences=False,
            kernel_regularizer=l1(0.0001), # <--- –î–û–ë–ê–í–õ–ï–ù–û: L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
            name='xlstm_memory_final'
        )(attention)
        xlstm_final = LayerNormalization()(xlstm_final)
        
        # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥) ...



3. –§–∞–π–ª: trading_env.py
–ú—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º exploration_bonus –∏ entropy_bonus, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –±–æ–ª–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏.
3.1. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ exploration_bonus –∏ entropy_bonus:
–¢–µ–∫—É—â–∏–π exploration_bonus=0.5 –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º, –∞ entropy_bonus —Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º 0.5 –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω—ã–º.


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é _calculate_advanced_reward.


–ò–∑–º–µ–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç exploration_bonus –∏ entropy_bonus:
# –í trading_env.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ _calculate_advanced_reward(...):
# ...
    # –ë–æ–Ω—É—Å—ã –∑–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ VSA —Å–∏–≥–Ω–∞–ª—ã (–û–°–õ–ê–ë–õ–ï–ù–´ –ü–û–†–û–ì–ò)
    # ...

    # –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–µ VSA —Å–∏–≥–Ω–∞–ª—ã (–û–°–õ–ê–ë–õ–ï–ù–´ –ü–û–†–û–ì–ò)
    # ...

    # ... (speed_bonus, hold_penalty, xlstm_conf, xlstm_to_rl_map) ...

    # =====================================================================
    # –ù–û–í–´–ô –ë–õ–û–ö: –°–ö–û–†–†–ï–ö–¢–ò–†–û–í–ê–ù–ù–´–ô –ë–û–ù–£–° –ó–ê –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ò –≠–ù–¢–†–û–ü–ò–Æ
    # =====================================================================
    exploration_bonus = 0
    # –ú–µ–Ω—å—à–∏–π, –Ω–æ –≤—Å–µ –µ—â–µ —Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–∏–π –±–æ–Ω—É—Å
    if action in [0, 1]: # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ - BUY –∏–ª–∏ SELL
        exploration_bonus = 0.2 # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 0.5 –Ω–∞ 0.2
    
    entropy_bonus = 0
    # –û—Å–ª–∞–±–ª—è–µ–º –±–æ–Ω—É—Å –∑–∞ —ç–Ω—Ç—Ä–æ–ø–∏—é
    entropy = -np.sum(xlstm_prediction * np.log(xlstm_prediction + 1e-10))
    normalized_entropy = entropy / np.log(len(xlstm_prediction))
    entropy_bonus = normalized_entropy * 0.2 # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 0.5 –Ω–∞ 0.2
    # =====================================================================
    # –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê
    # =====================================================================

    total_reward = base_reward + vsa_bonus + vsa_penalty + speed_bonus + hold_penalty + exploration_bonus + entropy_bonus
    
    return total_reward



–ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–º—É –ø—Ä–æ—Ü–µ–Ω—Ç—É HOLD –≤ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞—Å—Ç –º–æ–¥–µ–ª–∏ –±–æ–ª—å—à–µ "–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –ø—Ä–∏–º–µ—Ä–æ–≤ HOLD.
–û—Å–ª–∞–±–ª–µ–Ω–Ω—ã–µ –≤–µ—Å–∞ –∫–ª–∞—Å—Å–æ–≤ –∏ —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è: –£–º–µ–Ω—å—à–µ–Ω–∏–µ additional_weight_multiplier –∏ l2 –ø–æ–∑–≤–æ–ª–∏—Ç –º–æ–¥–µ–ª–∏ –±—ã—Ç—å –º–µ–Ω–µ–µ "–Ω–∞–∫–∞–∑–∞–Ω–Ω–æ–π" –∑–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ HOLD, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–æ–ª–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è–º.
L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –≤ XLSTMLayer: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è L1-—Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç —É–ø—Ä–æ—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å, –∑–∞—Å—Ç–∞–≤–ª—è—è –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Å–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω—É–ª–µ–≤—ã–º–∏, —á—Ç–æ –º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –æ–±–æ–±—â–µ–Ω–∏–µ.
–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã RL: –ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã –∑–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ —ç–Ω—Ç—Ä–æ–ø–∏—é –ø–æ–∑–≤–æ–ª—è—Ç RL-–∞–≥–µ–Ω—Ç—É –±—ã—Ç—å –±–æ–ª–µ–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º –∏ –Ω–µ –¥–µ–ª–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ–æ–±–¥—É–º–∞–Ω–Ω—ã—Ö BUY/SELL.


–î–∞–ª—å–Ω–µ–π—à–µ–º —É–ª—É—á—à–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å (Focal Loss): –≠—Ç–æ –±–æ–ª–µ–µ –º–æ—â–Ω—ã–π —Å–ø–æ—Å–æ–± –±–æ—Ä—å–±—ã —Å –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–º, —á–µ–º –ø—Ä–æ—Å—Ç–æ–µ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤.
–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ reward function –≤ RL: –ß—Ç–æ–±—ã —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ HOLD.
–£—Å–∏–ª–µ–Ω–∏–∏ —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.

üöÄ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∫–æ–¥–∞ –¥–ª—è –±–æ—Ä—å–±—ã —Å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ–º
1. –§–∞–π–ª: train_model.py
–ó–¥–µ—Å—å –º—ã –∑–∞–º–µ–Ω–∏–º CategoricalCrossentropy –Ω–∞ Focal Loss –∏ –µ—â–µ —Ä–∞–∑ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º patience –¥–ª—è EarlyStopping.
1.1. –ó–∞–º–µ–Ω–∏—Ç–µ CategoricalCrossentropy –Ω–∞ Focal Loss:
Focal Loss - —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å, –∫–æ—Ç–æ—Ä–∞—è —É–º–µ–Ω—å—à–∞–µ—Ç –≤–µ—Å "–ª–µ–≥–∫–∏—Ö" –ø—Ä–∏–º–µ—Ä–æ–≤ (—Ç–æ –µ—Å—Ç—å, —Ö–æ—Ä–æ—à–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä, HOLD) –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–µ—Å "—Ç—Ä—É–¥–Ω—ã—Ö" –ø—Ä–∏–º–µ—Ä–æ–≤ (BUY/SELL). –≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ—Ä—å–±—ã —Å –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–º –∫–ª–∞—Å—Å–æ–≤, –∫–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–æ.


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é train_xlstm_rl_system.


–ò–∑–º–µ–Ω–∏—Ç–µ –∫–æ–º–ø–∏–ª—è—Ü–∏—é –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Focal Loss:
# –í train_model.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ train_xlstm_rl_system(...):
# ...
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ò–ú–ü–û–†–¢ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Ä—è–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ –∏–º–ø–æ—Ä—Ç–∞–º–∏ Keras:
# from focal_loss import SparseCategoricalFocalLoss # –î–ª—è SparseCategoricalFocalLoss
# –ò–õ–ò:
from tensorflow_addons.losses import SigmoidFocalCrossEntropy # –î–ª—è SigmoidFocalCrossEntropy
# –ï—Å–ª–∏ tensorflow_addons –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: !pip install tensorflow-addons

# ...
xlstm_model.model.compile(
    optimizer=optimizer,
    # –ò–ó–ú–ï–ù–ï–ù–û: –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ Focal Loss
    # –ï—Å–ª–∏ —É –≤–∞—Å one-hot encoded –º–µ—Ç–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SigmoidFocalCrossEntropy
    loss=SigmoidFocalCrossEntropy(alpha=0.25, gamma=2.0), # <--- –ò–ó–ú–ï–ù–ï–ù–û: alpha –∏ gamma –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å
    # –ï—Å–ª–∏ –º–µ—Ç–∫–∏ –≤ –≤–∏–¥–µ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª (0, 1, 2), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SparseCategoricalFocalLoss
    # loss=SparseCategoricalFocalLoss(gamma=2, from_logits=True), # –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    metrics=[
        'accuracy',
        tf.keras.metrics.Precision(name='precision'),
        tf.keras.metrics.Recall(name='recall'),
        tf.keras.metrics.Precision(name='precision_0', class_id=0),
        tf.keras.metrics.Precision(name='precision_1', class_id=1),
        tf.keras.metrics.Precision(name='precision_2', class_id=2),
        tf.keras.metrics.Recall(name='recall_0', class_id=0),
        tf.keras.metrics.Recall(name='recall_1', class_id=1),
        tf.keras.metrics.Recall(name='recall_2', class_id=2),
    ]
)
# ...

–í–∞–∂–Ω–æ: –î–ª—è Focal Loss –≤–∞–º, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É tensorflow-addons:
!pip install tensorflow-addons

–ò–ª–∏ –Ω–∞–π—Ç–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é Focal Loss –¥–ª—è Keras, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tensorflow-addons.


1.2. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ patience –¥–ª—è EarlyStopping:
–ú–æ–¥–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å –Ω–∞ 24 —ç–ø–æ—Ö–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–≤ –≤–µ—Å–∞ —Å 4-–π. –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ patience=20 –≤—Å–µ –µ—â–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–º. –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –µ–≥–æ –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–º, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ, –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ.


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é train_xlstm_rl_system.


–ò–∑–º–µ–Ω–∏—Ç–µ patience –¥–ª—è tf.keras.callbacks.EarlyStopping:
# –í train_model.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ train_xlstm_rl_system(...):
# ...
    callbacks = [
        tf.keras.callbacks.EarlyStopping(
            monitor='val_loss',
            patience=10,  # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 20 –Ω–∞ 10 (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Å—Ç–æ–ø)
            restore_best_weights=True,
            verbose=1
        ),
# ...



2. –§–∞–π–ª: trading_env.py
–ú—ã –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏–º —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞–≥—Ä–∞–¥, —á—Ç–æ–±—ã —è–≤–Ω–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–∞—Ç—å –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ HOLD –∏ –Ω–∞–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ BUY/SELL, –∫–æ–≥–¥–∞ —Ä—ã–Ω–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏.
2.1. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ _calculate_advanced_reward –¥–ª—è —è–≤–Ω–æ–≥–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è HOLD:


–ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é _calculate_advanced_reward.


–ò–∑–º–µ–Ω–∏—Ç–µ –ª–æ–≥–∏–∫—É –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å hold_reward –∏ overtrading_penalty:
# –í trading_env.py, –≤ —Ñ—É–Ω–∫—Ü–∏–∏ _calculate_advanced_reward(...):
# ...
    base_reward = pnl_pct if pnl_pct != 0 else 0
    
    # ... (vsa_bonus, vsa_penalty) ...

    # ... (speed_bonus, hold_penalty) ...

    # =====================================================================
    # –ù–û–í–´–ô –ë–õ–û–ö: –Ø–í–ù–û–ï –í–û–ó–ù–ê–ì–†–ê–ñ–î–ï–ù–ò–ï –ó–ê HOLD –ò –®–¢–†–ê–§ –ó–ê OVERTRADING
    # =====================================================================
    hold_reward = 0
    overtrading_penalty = 0

    # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ HOLD
    if action == 2: # HOLD
        # –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–∞–µ–º –∑–∞ HOLD, –µ—Å–ª–∏ —Ä—ã–Ω–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏
        # (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, –Ω–µ—Ç —Å–∏–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞)
        current_row = self.df.iloc[self.current_step]
        volatility = current_row.get('ATR_14', 0) / current_row.get('close', 1) # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
        adx = current_row.get('ADX_14', 0)

        if volatility < 0.005 and adx < 25: # –ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Å–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥
            hold_reward = 0.5 # –ù–µ–±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π HOLD
        elif volatility > 0.01 and adx > 30: # –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Å–∏–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥ - HOLD –º–µ–Ω–µ–µ –∂–µ–ª–∞—Ç–µ–ª–µ–Ω
            hold_reward = -0.5 # –ù–µ–±–æ–ª—å—à–æ–π —à—Ç—Ä–∞—Ñ –∑–∞ HOLD –≤ —Ç—Ä–µ–Ω–¥–µ
        else:
            hold_reward = 0.1 # –ù–µ–±–æ–ª—å—à–æ–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∑–∞ HOLD
        
        # –®—Ç—Ä–∞—Ñ –∑–∞ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ –æ–Ω–∞ —É–±—ã—Ç–æ—á–Ω–∞)
        if pnl_pct < 0 and self.steps_in_position > 30:
            hold_penalty = -3 # –£–∂–µ –µ—Å—Ç—å, –Ω–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ HOLD
        
    else: # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ BUY –∏–ª–∏ SELL (–Ω–µ HOLD)
        # –®—Ç—Ä–∞—Ñ –∑–∞ overtrading (—Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ —Å–¥–µ–ª–∫–∏, –∫–æ–≥–¥–∞ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º VSA-—Å–∫–æ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "—è–≤–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞"
        current_row = self.df.iloc[self.current_step]
        vsa_buy_score = (0.3 * (current_row.get('vsa_no_supply', 0) == 1) + 0.3 * (current_row.get('vsa_stopping_volume', 0) == 1) + 0.4 * (current_row.get('vsa_strength', 0) > 0.1))
        vsa_sell_score = (0.3 * (current_row.get('vsa_no_demand', 0) == 1) + 0.3 * (current_row.get('vsa_climactic_volume', 0) == 1) + 0.4 * (current_row.get('vsa_strength', 0) < -0.1))

        if action == 1 and vsa_buy_score < 0.4: # –ï—Å–ª–∏ BUY, –Ω–æ VSA-—Å–∫–æ—Ä –Ω–∏–∑–∫–∏–π
            overtrading_penalty = -1.0
        elif action == 0 and vsa_sell_score < 0.4: # –ï—Å–ª–∏ SELL, –Ω–æ VSA-—Å–∫–æ—Ä –Ω–∏–∑–∫–∏–π
            overtrading_penalty = -1.0
    # =====================================================================
    # –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê
    # =====================================================================

    # ... (xlstm_conf, xlstm_to_rl_map, exploration_bonus, entropy_bonus) ...

    total_reward = base_reward + vsa_bonus + vsa_penalty + speed_bonus + hold_penalty + exploration_bonus + entropy_bonus + hold_reward + overtrading_penalty # <--- –î–û–ë–ê–í–õ–ï–ù–û: hold_reward, overtrading_penalty
    
    return total_reward



3. –§–∞–π–ª: rl_agent.py
–ú—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º ent_coef –¥–ª—è PPO/SAC, —á—Ç–æ–±—ã –¥–∞—Ç—å –∞–≥–µ–Ω—Ç—É –±–æ–ª—å—à–µ —Å–≤–æ–±–æ–¥—ã –≤ –≤—ã–±–æ—Ä–µ –¥–µ–π—Å—Ç–≤–∏–π.
3.1. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ ent_coef –¥–ª—è PPO/SAC:
–£–≤–µ–ª–∏—á–µ–Ω–∏–µ ent_coef –ø–æ–æ—â—Ä—è–µ—Ç –∞–≥–µ–Ω—Ç–∞ –∫ –±–æ–ª–µ–µ —Å–ª—É—á–∞–π–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é, —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –µ–º—É –≤—ã–±—Ä–∞—Ç—å—Å—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–∏–Ω–∏–º—É–º–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å BUY/SELL) –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –≤–∫–ª—é—á–∞—è HOLD.


–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ build_agent.


–ò–∑–º–µ–Ω–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é PPO –∏ SAC:
# –í rl_agent.py, –≤ –∫–ª–∞—Å—Å–µ IntelligentRLAgent, –≤ –º–µ—Ç–æ–¥–µ build_agent(...):
# ...
        self.model = PPO(
            'MlpPolicy',
            vec_env,
            # ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) ...
            ent_coef=0.05, # <--- –ò–ó–ú–ï–ù–ï–ù–û —Å 0.03 –Ω–∞ 0.05 (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —ç–Ω—Ç—Ä–æ–ø–∏—é –µ—â–µ –±–æ–ª—å—à–µ)
            vf_coef=0.5,
            max_grad_norm=0.5,
            # ...
        )
        
    elif self.algorithm == 'SAC':
        self.model = SAC(
            'MlpPolicy',
            vec_env,
            # ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) ...
            ent_coef='auto', # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å 'auto' –∏–ª–∏ –∑–∞–¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 0.05
            policy_kwargs=dict(net_arch=[256, 256]),
            verbose=0,
            tensorboard_log="./tensorboard_logs/",
            progress_bar=False
        )
# ...




–ü–æ—á–µ–º—É —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø–æ–º–æ—á—å:
–ú—ã —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ —Ä–µ—à–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è HOLD –∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–µ—Ç–æ–¥—ã:

Focal Loss: –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ. –û–Ω–æ –Ω–∞–ø—Ä—è–º—É—é –±–æ—Ä–µ—Ç—Å—è —Å –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–º, –∑–∞—Å—Ç–∞–≤–ª—è—è –º–æ–¥–µ–ª—å —É–¥–µ–ª—è—Ç—å –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è —Ç—Ä—É–¥–Ω—ã–º (BUY/SELL) –∏ —Ä–µ–¥–∫–∏–º –ø—Ä–∏–º–µ—Ä–∞–º, –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—Ä–∏ —ç—Ç–æ–º –∫–ª–∞—Å—Å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ (HOLD).
–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–≥—Ä–∞–¥ RL:

–Ø–≤–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π HOLD: –°—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç –∞–≥–µ–Ω—Ç–∞ –≤—ã–±–∏—Ä–∞—Ç—å HOLD, –∫–æ–≥–¥–∞ —Ä—ã–Ω–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏.
–®—Ç—Ä–∞—Ñ –∑–∞ overtrading: –ù–∞–∫–∞–∑—ã–≤–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ –∑–∞ –Ω–µ–æ–±–¥—É–º–∞–Ω–Ω—ã–µ BUY/SELL, –∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–∏–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–æ–ª–µ–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ–º—É –∏ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.


–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π ent_coef –≤ RL: –î–∞–µ—Ç –∞–≥–µ–Ω—Ç—É –±–æ–ª—å—à–µ —Å–≤–æ–±–æ–¥—ã –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –µ–º—É –Ω–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É BUY/SELL –∏ HOLD.
–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π EarlyStopping patience: –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π patience –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ val_loss –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞—Å—Ç–∏.

