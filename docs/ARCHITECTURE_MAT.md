# Архитектура нового трейдинг-бота MAT (Market Analysis Transformer)

## 1. Введение

Этот документ описывает глобальное перепроектирование существующего трейдинг-бота. Основная цель — замена текущей архитектуры, основанной на Tensorflow DQN, на более современную и гибкую систему, использующую две специализированные нейронные сети: **LSTM** для анализа свечных паттернов и **xLSTM** для анализа технических индикаторов. Проект также включает удаление устаревших моделей (XGBoost, Kalman Filter, GRP) и создание продвинутой системы симуляции торгов, максимально приближенной к реальным условиям биржи Bybit.

## 2. Ключевые изменения и цели

- **Отказ от старых моделей:** Полное удаление `Tensorflow DQN`, `XGBoost`, `Kalman Filter` и `GRP` из кодовой базы.
- **Новая двухмодельная архитектура:**
    1. **LSTM для паттернов:** Специализированная модель для распознавания и анализа свечных паттернов.
    2. **xLSTM для индикаторов:** Продвинутая модель для анализа временных рядов технических индикаторов.
- **Новый набор признаков:**
    - **Паттерны:** Молот, Поглощение, Утренняя звезда, Вечерняя звезда, Три белых солдата.
    - **Индикаторы:** RSI, MACD, Bollinger Bands, ADX, Stochastic.
- **Автономное управление сделками:** Полный отказ от статических стоп-лоссов и тейк-профитов. Решения о закрытии позиций принимаются моделями на основе консенсуса.
- **Реалистичный риск-менеджмент:**
    - Учет комиссии Bybit (0.11% на мейкер и тейкер).
    - Введение штрафов за "пересиживание" в сделках для стимуляции своевременного закрытия.
- **Продвинутая симуляция:** Создание симулятора на основе `historical_data.csv` для тестирования каждой модели по отдельности и их совместной работы.

## 3. Детальное проектирование архитектуры

### 3.1. Модуль данных (`data_loader.py` и `feature_engineering.py`)

1.  **`data_loader.py`**: Функционал остается прежним — загрузка исторических и live-данных.
2.  **`feature_engineering.py`**: Модуль был значительно переработан.
    - **`calculate_features`**: Функция теперь вычисляет только новый, утвержденный набор из 5 индикаторов: `RSI`, `MACD`, `Bollinger Bands`, `ADX`, `Stochastic`.
    - **`detect_candlestick_patterns`**: Новая функция, которая обнаруживает заданные свечные паттерны на входных данных OHLC с использованием `talib`.

### 3.2. Модели (`models/`)

Создана новая директория `models/` для хранения файлов моделей.

1.  **`models/lstm_pattern_model.py`**:
    - **Класс `LSTMPatternModel`**: Реализован класс для создания, обучения и использования модели LSTM для анализа паттернов.
2.  **`models/xlstm_indicator_model.py`**:
    - **Класс `XLSTMIndicatorModel`**: Создан класс-заглушка для модели xLSTM. Требуется дальнейшее исследование для полной реализации.

### 3.3. Модуль принятия решений (`trade_manager.py`)

- **`ConsensusDecisionMaker`**: Реализован новый класс, который получает прогнозы от обеих моделей и принимает решение на основе взвешенного консенсуса.

### 3.4. Симулятор торгов (`simulation_engine.py`)

- **`SimulationEngine`**: Реализован новый класс для тестирования и оценки торговых стратегий на исторических данных с тремя режимами работы: `LSTM_only`, `xLSTM_only`, `Consensus`.

### 3.5. Обучение (`train_model.py`)

- Файл был полностью переписан для обучения новых моделей `LSTMPatternModel` и `XLSTMIndicatorModel`.

### 3.6. Исполнение (`run_live_trading.py`)

- Файл был полностью переписан для работы с новой архитектурой, используя `ConsensusDecisionMaker` для принятия решений.

## 4. Как запустить

1.  **Обучение моделей:**
    ```bash
    python train_model.py --data historical_data.csv --model all
    ```
2.  **Запуск симуляции:**
    ```bash
    # В файле simulation_engine.py нужно раскомментировать и настроить блок if __name__ == '__main__':
    python simulation_engine.py
    ```
3.  **Запуск реальной торговли:**
    ```bash
    python run_live_trading.py
    ```

## 5. Задачи для реализации

- [x] **Задача 1: Рефакторинг.** Удалить все перечисленные в п.8 файлы и зависимости.
- [x] **Задача 2: Feature Engineering.** Реализовать функцию `detect_candlestick_patterns` в `feature_engineering.py`.
- [x] **Задача 3: Модель LSTM.** Создать `models/lstm_pattern_model.py` и реализовать класс `LSTMPatternModel`.
- [x] **Задача 4: Модель xLSTM.** Создать `models/xlstm_indicator_model.py` и реализовать класс `XLSTMIndicatorModel`.
- [x] **Задача 5: Механизм консенсуса.** Реализовать класс `ConsensusDecisionMaker` в `trade_manager.py`.
- [x] **Задача 6: Симулятор.** Создать `simulation_engine.py` с тремя режимами работы.
- [x] **Задача 7: Обучение.** Обновить `train_model.py` для обучения новых моделей.
- [x] **Задача 8: Интеграция.** Обновить `run_live_trading.py` для работы с новой архитектурой.
- [x] **Задача 9: Документация.** Обновить всю документацию проекта, отражая новую архитектуру.
