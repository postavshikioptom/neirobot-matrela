# Документация новой QDN модели

## Обзор

Новая QDN (Quantitative Deep Q-Network) модель представляет собой улучшенную версию DQN алгоритма для торгового робота, интегрированного с XGBoost для повышения точности прогнозирования торговых сигналов.

## Архитектура модели

### Входные данные
- Технические индикаторы (Bollinger Bands, MACD, RSI, и др.)
- Решение XGBoost (вероятность прибыльности сделки)
- Состояние портфеля (баланс, текущая позиция)
- История последних сделок (для контекста)

### Нейронная сеть
- Входной слой для приема обработанных признаков
- Скрытые слои с ReLU активациями
- Механизм внимания для фокусировки на важных признаках
- Память опыта (replay buffer) с приоритизацией
- Выходной слой с тремя нейронами (BUY, SELL, HOLD)

### Особенности новой архитектуры
1. Использование механизма внимания для лучшего понимания важности признаков
2. Интеграция решения XGBoost как дополнительного признака
3. Улучшенная память опыта с приоритизацией
4. Адаптивная нормализация входных данных

## Интеграция с системой

### Взаимодействие с XGBoost
- Прием решений XGBoost как дополнительного признака
- Комбинирование решений моделей для финального решения

### Взаимодействие с торговым окружением
- Расширение пространства наблюдений для новых признаков
- Адаптация нормализации данных
- Обновление расчета наград

## Создание новой модели

### Подготовка к созданию
Перед созданием новой модели необходимо убедиться в наличии:
- Файла `trade_log.csv` с историческими данными
- Наличия всех необходимых технических индикаторов в данных
- Наличия колонки `xgboost_prediction` в логах

### Процесс создания
Для создания новой чистой модели используется команда:
```
python train_model.py --create
```

Этот процесс:
1. Анализирует структуру данных в `trade_log.csv`
2. Определяет все необходимые признаки для модели
3. Создает пустую модель с правильной архитектурой входа
4. Сохраняет модель в файл `dqn_trading_model.zip`

### Требования к данным
- Файл `trade_log.csv` должен существовать и содержать данные
- Все необходимые индикаторы должны быть рассчитаны
- Структура данных должна соответствовать ожиданиям модели

## Обучение модели

### Источники данных
- Исторические данные из `historical_data.csv`
- Логи сделок из `trade_log.csv`
- Результаты предсказаний XGBoost

### Процесс обучения
1. Использование алгоритма Deep Q-Learning
2. Применение механизма целевой сети для стабильности
3. Использование памяти опыта с приоритизацией
4. Постепенное уменьшение скорости обучения (epsilon decay)

### Метрики обучения
- Средняя награда за эпизод
- Точность принятия решений
- Сходимость Q-значений
- Прибыльность на тестовых данных

## Оптимизация гиперпараметров

### Гиперпараметры нейронной сети
- Количество скрытых слоев и нейронов
- Типы функций активации
- Скорость обучения
- Размер батча

### Гиперпараметры DQN алгоритма
- Коэффициент дисконтирования (gamma)
- Скорость уменьшения epsilon
- Размер памяти опыта
- Частота обновления целевой сети

## Тестирование

### Модульное тестирование
- Проверка корректности работы каждого компонента модели
- Тестирование механизма внимания
- Проверка памяти опыта

### Интеграционное тестирование
- Проверка взаимодействия с XGBoost моделью
- Тестирование интеграции с торговым окружением

### Функциональное тестирование
- Проверка правильности выдачи торговых сигналов
- Тестирование различных рыночных условий

## Развертывание

### Замена существующей модели
- Обновление файла `dqn_trading_model.zip` новой моделью
- Обеспечение совместимости входных/выходных данных

### Обратная совместимость
- Поддержка старых моделей при необходимости
- Плавный переход на новую архитектуру

## Поддержка и развитие

### Мониторинг
- Отслеживание производительности модели
- Анализ прибыльности торговых сигналов
- Выявление проблем с переобучением

### Обновления
- Регулярное дообучение на новых данных
- Оптимизация гиперпараметров
- Расширение набора признаков